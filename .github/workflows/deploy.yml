name: Deploy to VPS

on:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Install rsync (just in case)
              run: sudo apt-get update && sudo apt-get install -y rsync

            - name: Copy files to VPS (exclude .env & node_modules)
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_DEPLOY_KEY }}
                  VPS_IP: ${{ secrets.VPS_IPV4 }}
                  VPS_PORT: ${{ secrets.VPS_SSH_PORT }}

              run: |
                  mkdir -p ~/.ssh
                  echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa
                  ssh-keyscan -p $VPS_PORT -H $VPS_IP >> ~/.ssh/known_hosts

                  # Synchronisation sans Ã©craser .env et node_modules
                  rsync -avz --delete \
                    -e "ssh -p $VPS_PORT -i ~/.ssh/id_rsa" \
                    --exclude='.env' \
                    --exclude='node_modules' \
                    --exclude='sync/backups' \
                    --exclude='uploads/**' \
                    ./ ubuntu@$VPS_IP:/var/www/discorev-back/

            - name: Install dependencies, migrate DB and restart server
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_DEPLOY_KEY }}
                  VPS_IP: ${{ secrets.VPS_IPV4 }}
                  VPS_PORT: ${{ secrets.VPS_SSH_PORT }}

              run: |
                  ssh -p $VPS_PORT -i ~/.ssh/id_rsa ubuntu@$VPS_IP << 'EOF'
                    cd /var/www/discorev-back

                    # Charger NVM pour rendre npm/npx disponibles
                    export NVM_DIR="$HOME/.nvm"
                    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

                    echo "ðŸ“¦ Installation des dÃ©pendances..."
                    npm install --omit=dev

                    echo "ðŸ”„ Lancement des migrations..."
                    npm run migrate

                    echo "ðŸš€ RedÃ©marrage du serveur..."
                    pm2 restart discorev || pm2 start server.js --name discorev
                  EOF
